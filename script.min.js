// ==UserScript==
// @name         OPS-mysql小助手
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description
/*
1. 优化 不用刷新页面也可以支持自动植入小助手，完成页面交互
*/
// @author       Michael.tang
// @match        http://ops.jyblife.com/*
// @require      http://libs.baidu.com/jquery/2.0.0/jquery.min.js
// @run-at       document-idle
// @compatible   Chrome
// @compatible   Firefox
// @compatible   Edge
// @compatible   Safari
// @compatible   Opera
// @compatible   UC
// @license      GPL-3.0-only
// @grant        none
// ==/UserScript==
!function(){if("function"==typeof window.CustomEvent)return!1;function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}e.prototype=window.Event.prototype,window.CustomEvent=e}(),function(){function e(e){var t=new CustomEvent(e,{detail:this});window.dispatchEvent(t)}var t=window.XMLHttpRequest;window.XMLHttpRequest=function(){var n=new t;return n.addEventListener("abort",function(){e.call(this,"ajaxAbort")},!1),n.addEventListener("error",function(){e.call(this,"ajaxError")},!1),n.addEventListener("load",function(){e.call(this,"ajaxLoad")},!1),n.addEventListener("loadstart",function(){e.call(this,"ajaxLoadStart")},!1),n.addEventListener("progress",function(){e.call(this,"ajaxProgress")},!1),n.addEventListener("timeout",function(){e.call(this,"ajaxTimeout")},!1),n.addEventListener("loadend",function(){e.call(this,"ajaxLoadEnd")},!1),n.addEventListener("readystatechange",function(){e.call(this,"ajaxReadyStateChange")},!1),n}}(),function(){"use strict";var e=e||window.$,t=!0,n=!1,i=function(e){return e.indexOf("Create Table")>-1&&e.indexOf("CREATE TABLE `")>-1},a=function(){if(!t)return!1;t=!1,e(".reset-row-show").length<=0&&(e(".ivu-card-body button").last().after('<button style="margin-left:5px;" type="button" class="ivu-btn ivu-btn-primary tree-show">\x3c!----\x3e <i class="ivu-icon ivu-icon-md-backspace"></i> <span>JSON展示&查询</span></button>'),e(".ivu-card-body button").last().after('<button style="margin-left:5px;" type="button" class="ivu-btn ivu-btn-primary reset-row-show">\x3c!----\x3e <i class="ivu-icon ivu-icon-md-backspace"></i> <span>重置为行展示&查询</span></button>'),e(".ivu-card-body button").last().after('<button style="margin-left:5px;" type="button" class="ivu-btn ivu-btn-primary full-screen">\x3c!----\x3e <i class="ivu-icon ivu-icon-md-backspace"></i> <span>全屏</span></button>')),e("body").undelegate(".ivu-page li","click"),e("body").delegate(".ivu-page li","click",function(){n&&function(){try{e("#out_pre").remove()}catch(e){}e(".ivu-table-wrapper").css({display:"block"})}()}),e("body").undelegate(".tree-show","click"),e("body").delegate(".tree-show","click",function(){n=!0,e(".ivu-card-body .ivu-btn.ivu-btn-success").trigger("click")}),e("body").undelegate(".ivu-card-body .ivu-btn.ivu-btn-success","click"),e("body").delegate(".ivu-card-body .ivu-btn.ivu-btn-success","click",function(){try{e("#out_pre").remove()}catch(e){}e(".ivu-table-wrapper").css({display:"block"}),e(".ivu-page").css("display","block")}),e("body").undelegate(".reset-row-show","click"),e("body").delegate(".reset-row-show","click",function(){n=!1,e(".ivu-card-body .ivu-btn.ivu-btn-success").trigger("click")}),e("body").undelegate(".full-screen","click"),e("body").delegate(".full-screen","click",function(){"全屏"==e(this).find("span").text()?(e(".main-header-con").css("display","none"),e(".sidebar-menu-con").css("display","none"),e(".ivu-col.ivu-col-span-6").css({display:"none"}),e(".edittable-test-con").css({display:"none"}),e(".single-page-con").css({padding:"0px"}),e(".main-header").css({padding:"0px"}),e(".ivu-card.ivu-card-bordered").css({width:"2080px"}),e(this).find("span").text("取消全屏")):(e(".main-header-con").css("display","block"),e(".sidebar-menu-con").css("display","block"),e(".ivu-col.ivu-col-span-6").css({display:"block"}),e(".edittable-test-con").css({display:"block"}),e(".single-page-con").css({padding:""}),e(".single-page-con").css({"padding-left":"200px"}),e(".main-header").css({padding:""}),e(".ivu-card.ivu-card-bordered").css({width:""}),e(this).find("span").text("全屏"))}),t=!0};new XMLHttpRequest;window.addEventListener("ajaxReadyStateChange",function(t){if(4==t.detail.readyState)if(/^http?:\/\/ops\.jyblife\.com:\d*\/api\/v\d+\/search$/.test(t.detail.responseURL)){if(t.detail.responseText&&n){var s=t.detail.responseText;i(s)&&(s=t.detail.responseText.replace(/\\n/g,"<br />&nbsp;&nbsp;&nbsp;&nbsp;")),function(t){try{e("#out_pre").remove()}catch(e){}e(".ivu-table-wrapper").css({display:"none"}),e(".ivu-table-wrapper").after('<pre id="out_pre" style="color:#00FF7F;background-color:black;"></pre>');var n=function(e){var t=[],n=0;for(n=0;n<e["title"].length;n++)t.push(e["title"][n]["title"]);var i=[];for(n=0;n<e["data"].length;n++)i.push(e["data"][n]);var a=[];for(n=0;n<i.length;n++){for(var s=i[n],o={},c=0;c<t.length;c++)o[t[c]]=s[t[c]];a.push(o)}return a}(t);i(JSON.stringify(t))?e("#out_pre").html(JSON.stringify(n,null,2)+"\n\n\n\n共："+t.len+"条结果"):e("#out_pre").text(JSON.stringify(n,null,2)+"\n\n\n\n共："+t.len+"条结果")}(s=JSON.parse(s)),e(".ivu-page").css("display","none")}}else/^http?:\/\/ops\.jyblife\.com:\d*\/api\/v\d+\/query_worklf/.test(t.detail.responseURL)&&(/^http?:\/\/ops\.jyblife\.com\/#\/querypage*$/.test(location.href)||/^http?:\/\/ops\.jyblife\.com\/#\/order\/serach-sql*$/.test(location.href))&&e("body").unbind("DOMNodeInserted").one("DOMNodeInserted",function(e){e.stopPropagation(),a()})}),window.addEventListener("ajaxAbort",function(e){})}();
